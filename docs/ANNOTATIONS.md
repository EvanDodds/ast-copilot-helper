# Annotation System

The annotation system in `ast-copilot-helper` provides code intelligence by analyzing and storing metadata about code structures. This document covers the SQLite-based annotation storage system.

## Overview

Annotations are generated by the Rust CLI parser and stored in a SQLite database for efficient querying and retrieval. The system supports:

- **Code Structure Analysis**: Functions, classes, methods, interfaces
- **Complexity Metrics**: Cyclomatic and cognitive complexity
- **Dependency Tracking**: Import/export relationships
- **Semantic Tags**: Categorization and classification
- **Performance Optimization**: Indexed queries and batch operations

## Architecture

### Storage Location

Annotations are stored in `.astdb/annotations.sqlite`, a standalone SQLite database separate from the main AST database.

**Key Design Decisions:**

- **Standalone Database**: Independent from main AST storage for flexibility
- **No Foreign Keys**: No dependencies on other tables for simplified schema
- **WAL Mode**: Write-Ahead Logging for better concurrent access
- **Prepared Statements**: Optimized query performance

### Database Schema

```sql
CREATE TABLE annotations (
  node_id TEXT PRIMARY KEY,           -- Unique identifier: {file}:{start}:{end}:{type}
  file_path TEXT NOT NULL,            -- Source file path
  start_line INTEGER NOT NULL,        -- Start line number
  end_line INTEGER NOT NULL,          -- End line number
  node_type TEXT NOT NULL,            -- Node type (function, class, method, etc.)
  signature TEXT,                     -- Code signature
  complexity_score REAL,              -- Cyclomatic complexity
  dependencies TEXT,                  -- JSON array of dependencies
  metadata TEXT,                      -- JSON object with additional data
  created_at INTEGER NOT NULL,        -- Unix timestamp (milliseconds)
  updated_at INTEGER NOT NULL         -- Unix timestamp (milliseconds)
);

-- Performance indexes
CREATE INDEX idx_annotations_file_path ON annotations(file_path);
CREATE INDEX idx_annotations_complexity ON annotations(complexity_score);
```

### Metadata Structure

The `metadata` field stores a JSON object with detailed information:

```typescript
{
  summary: string;                    // Generated summary
  language: string;                   // Source language
  parameters: Array<{                 // Function parameters
    name: string;
    type: string;
  }>;
  return_type: string | null;         // Return type
  modifiers: string[];                // Access modifiers (public, private, etc.)
  semantic_tags: string[];            // Tags (async, generator, etc.)
  complexity_metrics: {               // Detailed complexity breakdown
    cyclomatic: number;
    cognitive: number;
    max_nesting: number;
    decision_points: number;
    category: string;
    breakdown: {
      branches: number;
      loops: number;
      returns: number;
    };
  };
  dependencies_detail: {              // Detailed dependency structure
    imports: string[];
    exports: string[];
    calls: string[];
    internal_dependencies: string[];
    external_dependencies: string[];
  };
}
```

## Usage

### Generating Annotations

Use the `annotate` command to generate annotations for your codebase:

```bash
# Annotate all files in src/
yarn ast-copilot-helper annotate src/

# Annotate specific files
yarn ast-copilot-helper annotate src/file1.ts src/file2.ts

# Annotate with custom glob pattern
yarn ast-copilot-helper annotate --glob "**/*.{ts,js}"

# Batch processing for large codebases
yarn ast-copilot-helper annotate src/ --batch-size 50 --max-concurrency 4

# Dry run to preview files
yarn ast-copilot-helper annotate src/ --dry-run
```

### Querying Annotations

The `AnnotationDatabaseManager` provides methods for querying annotations:

```typescript
import { AnnotationDatabaseManager } from "@ast-copilot-helper/ast-helper";
import { ASTDatabaseManager } from "@ast-copilot-helper/ast-helper";

// Initialize managers
const dbManager = new ASTDatabaseManager(".astdb");
const annotationManager = new AnnotationDatabaseManager(dbManager);
await annotationManager.initialize();

// Get all annotations for a file
const annotations =
  await annotationManager.getAnnotationsByFile("src/example.ts");

// Get a specific annotation
const annotation = await annotationManager.getAnnotation(
  "src/example.ts:10:20:function",
);

// Query with filters
const complexFunctions = await annotationManager.queryAnnotations({
  node_type: "function",
  min_complexity: 10,
  limit: 20,
});

// Get statistics
const stats = await annotationManager.getStatistics();
console.log(`Total annotations: ${stats.total_annotations}`);
console.log(`Average complexity: ${stats.avg_complexity}`);
console.log(`Node types:`, stats.node_types);
```

### Database Manager API

#### Initialization

```typescript
// Create and initialize
const manager = new AnnotationDatabaseManager(dbManager);
await manager.initialize();

// Check if ready
if (manager.isReady()) {
  // Perform operations
}

// Get database path
const dbPath = manager.getDatabasePath();
```

#### Create Operations

```typescript
// Insert single annotation
await manager.insertAnnotation({
  node_id: "src/file.ts:10:20:function",
  file_path: "src/file.ts",
  start_line: 10,
  end_line: 20,
  node_type: "function",
  signature: "function example(): void",
  complexity_score: 5,
  dependencies: ["fs", "path"],
  metadata: { summary: "Example function" },
});

// Batch insert (uses transaction for performance)
await manager.insertAnnotations([
  {
    /* annotation 1 */
  },
  {
    /* annotation 2 */
  },
  // ... more annotations
]);
```

#### Read Operations

```typescript
// Get single annotation
const annotation = await manager.getAnnotation(node_id);

// Get all annotations for a file
const fileAnnotations = await manager.getAnnotationsByFile("src/file.ts");

// Get all annotations
const allAnnotations = await manager.getAllAnnotations();

// Query with filters
const results = await manager.queryAnnotations({
  file_path: "src/file.ts", // Filter by file
  node_type: "function", // Filter by type
  min_complexity: 5, // Min complexity
  max_complexity: 15, // Max complexity
  limit: 50, // Limit results
  offset: 0, // Pagination offset
});
```

#### Update Operations

```typescript
// Update existing annotation
await manager.updateAnnotation({
  node_id: "src/file.ts:10:20:function",
  file_path: "src/file.ts",
  start_line: 10,
  end_line: 20,
  node_type: "function",
  signature: "function example(x: number): void",
  complexity_score: 7,
  metadata: { summary: "Updated summary" },
});
```

#### Delete Operations

```typescript
// Delete single annotation
await manager.deleteAnnotation(node_id);

// Delete all annotations for a file
await manager.deleteAnnotationsByFile("src/file.ts");
```

#### Statistics

```typescript
// Get database statistics
const stats = await manager.getStatistics();

// Example output:
{
  total_annotations: 150,
  files_count: 25,
  node_types: {
    function: 80,
    class: 30,
    method: 35,
    interface: 5
  },
  avg_complexity: 4.2,
  last_updated: 1696867200000
}
```

#### Cleanup

```typescript
// Close database connection
manager.close();

// Can reinitialize after closing
await manager.initialize();
```

## Performance Characteristics

### Batch Operations

- **Small batches (< 100)**: ~50ms
- **Medium batches (100-500)**: ~200ms
- **Large batches (1000+)**: < 5 seconds
- **Transaction-based**: All inserts in a single transaction for optimal performance

### Query Performance

- **Indexed queries** (file_path, complexity_score): < 50ms
- **Full table scan** (1000 records): ~100ms
- **Statistics calculation**: ~150ms

### Storage Efficiency

- **Average annotation size**: ~1-2KB (with metadata)
- **1000 annotations**: ~1-2MB database size
- **Compression**: SQLite's built-in page compression

## Integration with Other Commands

### Embed Command

The `embed` command reads annotations from SQLite to generate embeddings:

```bash
# Generate embeddings from annotations
yarn ast-copilot-helper embed

# Embeddings use annotation summaries and metadata
```

The embed command automatically:

1. Loads annotations from SQLite
2. Transforms to embedding format
3. Generates vector embeddings
4. Stores in embedding database

### Status Command

Check annotation statistics:

```bash
yarn ast-copilot-helper status
```

Includes:

- Total annotation count
- Files with annotations
- Node type distribution
- Average complexity score

## Migration Notes

**Important**: This is a **fresh implementation** with no migration path from previous versions.

- ❌ **No JSON file support**: Old `.astdb/annotations/*.json` files are not read
- ✅ **Clean slate**: Designed for new installations only
- ✅ **No backward compatibility**: Simplified implementation without migration code
- ✅ **Forward compatibility**: SQLite schema supports future enhancements

**For new projects**: Simply run `annotate` command to populate the database.

## Best Practices

### Performance

1. **Use batch operations** for multiple annotations
2. **Leverage indexed queries** (file_path, complexity_score)
3. **Close connections** when done to release resources
4. **Monitor database size** for large codebases

### Data Management

1. **Delete old annotations** before re-annotating files
2. **Use transactions** for bulk operations
3. **Regular statistics** to monitor database health
4. **Backup important data** before major updates

### Query Optimization

```typescript
// ✅ Good: Use indexed fields
const results = await manager.queryAnnotations({
  file_path: "src/file.ts",  // Indexed
  min_complexity: 5           // Indexed
});

// ❌ Avoid: Full table scans when possible
const all = await manager.getAllAnnotations();
const filtered = all.filter(a => /* complex filter */);

// ✅ Better: Use database queries
const results = await manager.queryAnnotations({
  node_type: "function",
  min_complexity: 10
});
```

## Troubleshooting

### Database Locked

**Problem**: `database is locked` error

**Solution**:

- Ensure no other processes are accessing the database
- Check for stale `.db-wal` or `.db-shm` files
- Close connections properly with `manager.close()`

### Performance Degradation

**Problem**: Slow queries over time

**Solution**:

```typescript
// Run VACUUM to optimize database
// Note: This requires manual SQL execution
```

### Corrupted Database

**Problem**: Database corruption or schema mismatch

**Solution**:

1. Delete `.astdb/annotations.sqlite`
2. Re-run `annotate` command
3. Database will be recreated with correct schema

## Future Enhancements

Planned features for the annotation system:

- [ ] Incremental annotation updates
- [ ] Change tracking with timestamps
- [ ] Annotation versioning
- [ ] Custom annotation types
- [ ] Annotation import/export
- [ ] Performance benchmarking tools

## Related Documentation

- [Development Guide](../DEVELOPMENT.md) - General development setup
- [CLI Commands](../README.md#cli-commands) - Command-line interface reference
- [Process Improvements](./development/process-improvements.md) - Code quality standards
- [Annotation Performance](./ANNOTATION-PERFORMANCE.md) - Performance optimization guide

## Support

For issues or questions:

- GitHub Issues: [ast-copilot-helper/issues](https://github.com/EvanDodds/ast-copilot-helper/issues)
- Documentation: [docs/](../docs/)
